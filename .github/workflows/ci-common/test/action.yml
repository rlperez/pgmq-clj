name: Common Test Steps
description: Runs common test steps like running tests and uploading coverage
inputs:
  testcontainer:
    description: Test container image to use
    required: true
  codecov_token:
    description: Security token to publish coverage
    required: false

runs:
  using: composite
  steps:
    - name: Run tests
      shell: bash
      env:
        TEST_CONTAINER: ${{ inputs.testcontainer }}
      run: |
        bb test coverage
        if [ ! -f target/coverage/codecov.json ]; then
           echo "Coverage report not found. Skipping Codecov upload."
           exit 0
        fi

    - name: Upload coverage reports to Codecov
      if: ${{ inputs.codecov_token != '' && inputs.testcontainer == 'quay.io/tembo/pg17-pgmq' }}
      uses: codecov/codecov-action@v5
      with:
        token: ${{ inputs.codecov_token }}
        slug: rlperez/pgmq-clj
        files: target/coverage/codecov.json
